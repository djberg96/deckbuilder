<%= form_with(model: card, html: { class: 'needs-validation', id: 'card-form' }) do |form| %>
  <% if card.errors.any? %>
    <div class="alert alert-danger">
      <h4 class="alert-heading"><%= pluralize(card.errors.count, "error") %> prohibited this card from being saved:</h4>
      <ul class="mb-0">
        <% card.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.label :name, class: 'form-label' %>
    <%= form.text_field :name, class: 'form-control', size: 50, autofocus: true %>
  </div>

  <div class="mb-3">
    <%= form.label :description, class: 'form-label' %>
    <%= form.text_area :description, class: 'form-control', rows: 3 %>
  </div>

  <div class="mb-3">
    <%= form.label :game_id, 'Game', class: 'form-label' %>
    <%= form.select :game_id, Game.all.map { |game| [game.edition.present? ? "#{game.name} (#{game.edition})" : game.name, game.id] }, {}, class: 'form-select' %>
  </div>

  <h5>Data Attributes</h5>
  <div id="data-attributes">
    <%
      data_hash = if card.data.respond_to?(:to_h)
        card.data.to_h
      elsif card.data.respond_to?(:each_pair)
        h = {}
        card.data.each_pair { |k, v| h[k.to_s] = v }
        h
      elsif card.data.is_a?(Hash)
        card.data
      else
        {}
      end

      data_hash = data_hash.transform_keys(&:to_s) if data_hash.is_a?(Hash)
    %>

    <% if data_hash.is_a?(Hash) && data_hash.any? %>
      <% data_hash.each do |key, value| %>
        <div class="row mb-2 data-attribute">
          <div class="col-md-4">
            <input type="text" class="form-control data-key" value="<%= key %>">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control data-value" name="card[data][<%= key %>]" value="<%= value %>">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm remove-attribute">Remove</button>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
  <button type="button" id="add-attribute" class="btn btn-secondary mb-3">Add Attribute</button>

  <div id="attribute-template" style="display:none">
    <div class="row mb-2 data-attribute">
      <div class="col-md-4">
        <input type="text" class="form-control data-key" placeholder="Key">
      </div>
      <div class="col-md-6">
        <input type="text" class="form-control data-value" name="card[data][__new__]" placeholder="Value">
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-danger btn-sm remove-attribute">Remove</button>
      </div>
    </div>
  </div>

  <h5>Images</h5>
  <div id="card-images" class="mb-3">
    <% if card.card_images.any? %>
      <div class="mb-2">
        <% card.card_images.each do |img| %>
          <div class="card mb-2" style="width: 10rem; display:inline-block; margin-right: 8px;">
            <% if img.data.present? && img.content_type.present? %>
              <%= image_tag("data:#{img.content_type};base64,#{Base64.strict_encode64(img.data)}", class: 'card-img-top', style: 'max-width:100%; height:auto;') %>
            <% else %>
              <div class="card-body">No preview</div>
            <% end %>
            <div class="card-footer">
              <label class="form-check-label">
                <input type="checkbox" name="card[remove_image_ids][]" value="<%= img.id %>"> Delete
              </label>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="mb-2">
      <%= file_field_tag 'card[new_images][]', multiple: true, accept: 'image/*', class: 'form-control' %>
      <div class="form-text">Maximum size per image: 64 KB.</div>
    </div>
  </div>

  <div class="actions">
    <%= form.submit class: 'btn btn-primary' %>
  </div>
<% end %>

<script>
$(document).off('click', '#add-attribute').on('click', '#add-attribute', function(e) {
  e.preventDefault();
  var template = $('#attribute-template').html();
  $('#data-attributes').append(template);
  return false;
});

$(document).off('click', '.remove-attribute').on('click', '.remove-attribute', function() {
  $(this).closest('.data-attribute').remove();
});

$(document).off('input', '.data-key').on('input', '.data-key', function() {
  var key = $(this).val();
  var valueInput = $(this).closest('.data-attribute').find('.data-value');
  if (key) {
    valueInput.attr('name', 'card[data][' + key + ']');
  } else {
    valueInput.attr('name', 'card[data][__new__]');
  }
  // Clear any inline validation markers when the key changes
  $(this).removeClass('is-invalid');
  $(this).closest('.data-attribute').find('.invalid-feedback').remove();

  // Re-enable submit buttons on change (in case they were disabled earlier)
  var btns = $('#card-form').find('input[type=submit], button[type=submit]');
  btns.prop('disabled', false).removeAttr('disabled');
});

// On-submit serializer: ensure only alphanumeric keys are submitted and avoid duplicate inputs
$(document).off('submit', '#card-form').on('submit', '#card-form', function(e) {
  var form = $(this);
  var pairs = [];
  var valid = true;
  var invalidElem = null;

  // Collect and validate visible attribute rows without mutating the DOM yet
  $('.data-attribute').each(function() {
    if (this.offsetParent === null) { return; } // skip template

    var key = $(this).find('.data-key').val() || '';
    key = key.toString().trim();
    var val = $(this).find('.data-value').val() || '';

    if (key === '') { return; }

    if (!/^[A-Za-z0-9]+$/.test(key)) {
      valid = false;
      invalidElem = $(this).find('.data-key');
      return false; // break
    }

    pairs.push({ key: key, value: val, row: $(this) });
  });

  if (!valid) {
    e.preventDefault();
    // show inline error next to the offending key
    if (invalidElem) {
      invalidElem.addClass('is-invalid');
      invalidElem.after('<div class="invalid-feedback">Keys may contain only letters and numbers.</div>');
      invalidElem.focus();
    }

    // Re-enable submit buttons in case Rails UJS or other handlers disabled them on click
    // Use setTimeout to ensure this runs after other click handlers that may disable the button
    setTimeout(function() {
      var btns = form.find('input[type=submit], button[type=submit]');
      btns.each(function() {
        var $b = $(this);
        // restore original text if rails-ujs stored it
        var original = $b.data('ujs:enable-with') || $b.data('enable-with');
        if (original) {
          if ($b.is('input')) { $b.val(original); } else { $b.html(original); }
        }
        $b.prop('disabled', false);
        $b.removeAttr('disabled');
      });
    }, 0);

    return false;
  }

  // Passed validation: remove previous hidden helper inputs, then inject fresh ones and remove visible names
  form.find('input[type="hidden"][name^="card[data]"]').remove();
  pairs.forEach(function(p) {
    $('<input>').attr({ type: 'hidden', name: 'card[data][' + p.key + ']', value: p.value }).appendTo(form);
    p.row.find('.data-value').removeAttr('name');
  });

  // allow submit to continue
});
</script>
